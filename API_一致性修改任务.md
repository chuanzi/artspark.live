# Context
Filename: API_一致性修改任务.md
Created On: 2025-01-06 
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
用户发现`app/api/generate-portrait/route.ts`与`app/api/generate-animal-landmark/route.ts`的API调用方式不一致，希望将前者修改为与后者一样的调用方式。

# Project Overview
这是一个Next.js项目，包含两个图像生成API端点。两个端点都使用GRSAI服务生成图像，但实现方式存在差异。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)

## 当前状况分析

### generate-portrait/route.ts (需要修改的文件)
- 使用单一API地址配置：通过环境变量`GRSAI_API_URL`获取API地址
- 简单的错误处理：只有基本的try-catch和状态码检查
- 流式响应处理相对简单
- 超时处理：无明确的超时机制
- 重试机制：无重试逻辑

### generate-animal-landmark/route.ts (参考标准)
- **多API地址配置**：硬编码的API_ENDPOINTS数组，包含海外和国内备用地址
- **高级超时管理**：REQUEST_TIMEOUT (90秒) 和 CONNECTION_TIMEOUT (120秒)
- **智能重试机制**：每个端点最多重试2次，支持多地址轮询
- **增强错误处理**：详细的错误分类和处理策略
- **连接监控**：实时监控连接状态，防止长时间无响应
- **安全的流式响应**：包含Controller状态管理和资源清理

## 主要差异点
1. **API地址配置策略**：单一 vs 多地址备用
2. **超时处理**：无 vs 多层超时机制
3. **重试逻辑**：无 vs 智能重试
4. **错误处理粒度**：基础 vs 细致分类
5. **连接稳定性**：基础 vs 高级监控
6. **资源管理**：简单 vs 完善清理

## 技术约束
- 两个文件都使用相同的GRSAI_API_KEY环境变量
- 都使用相同的请求体结构和模型参数
- 都需要支持流式响应
- 需要保持相同的错误响应格式

# Proposed Solution (Populated by INNOVATE mode)

## 解决方案比较

### 方案一：完全替换策略 ⭐ 推荐
- 直接将portrait版本替换为animal-landmark的完整实现
- 保留portrait特有的PROMPT_TEMPLATE和参数验证
- 移除GRSAI_API_URL环境变量依赖，采用硬编码多地址配置
- 优势：完整的稳定性、代码一致性、用户体验统一
- 适合：用户明确要求"一样的调用方式"

### 方案二：模块化重构策略
- 提取核心网络处理功能为独立模块
- 两个API共享网络处理逻辑
- 优势：代码复用、便于维护
- 劣势：架构复杂度增加

### 方案三：渐进式迁移策略
- 分步骤逐步升级portrait版本
- 优势：风险可控
- 劣势：实施周期长

## 最终选择：完全替换策略
基于用户需求和代码一致性考虑，采用方案一进行完全替换，确保两个API端点使用完全相同的网络处理机制。

# Implementation Plan (Generated by PLAN mode)

## 变更规范

### 目标文件
- **文件路径**: `app/api/generate-portrait/route.ts`
- **变更策略**: 完全重写，采用animal-landmark版本的架构

### 核心功能迁移

**1. API地址配置重构**
- 移除环境变量`GRSAI_API_URL`依赖
- 添加硬编码`API_ENDPOINTS`数组：海外优先，国内备用

**2. 超时管理系统**
- 添加`REQUEST_TIMEOUT = 90000`（90秒请求超时）
- 添加`CONNECTION_TIMEOUT = 120000`（120秒连接监控）

**3. 网络处理函数**
- 添加`fetchWithTimeout`函数：支持AbortController超时控制
- 添加`tryApiEndpoints`函数：多地址轮询和智能重试

**4. 增强错误处理**
- 实现详细错误分类（网络中断、超时、服务器错误）
- 增加重连机制（每个端点最多重试2次）

**5. 流式响应安全性**
- 添加Controller状态管理（safeEnqueue、safeClose、safeError）
- 实现连接监控定时器
- 完善资源清理机制

**6. 业务逻辑保持**
- 保留原有PROMPT_TEMPLATE（人物肖像特定）
- 保持characterDescription参数验证
- 维持相同的请求体结构和响应格式

## Implementation Checklist:

1. 在文件顶部添加API地址配置和超时常量 ✅
2. 实现fetchWithTimeout函数，支持超时控制 ✅
3. 实现tryApiEndpoints函数，支持多地址重试 ✅
4. 重写POST函数的参数验证部分，保持characterDescription逻辑 ✅
5. 移除GRSAI_API_URL环境变量的检查和使用 ✅
6. 保留GRSAI_API_KEY环境变量的验证逻辑 ✅
7. 替换API请求逻辑，使用tryApiEndpoints函数 ✅
8. 重写ReadableStream处理逻辑，添加安全控制函数 ✅
9. 实现连接监控定时器和心跳检测 ✅
10. 添加增强的网络错误处理和重连机制 ✅
11. 完善资源清理和Controller状态管理 ✅
12. 保持原有的响应头配置和错误响应格式 ✅

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> 当前步骤: "实施完成，等待确认"

# Task Progress (Appended by EXECUTE mode after each step completion)

*   2025-01-06
    *   步骤: 检查清单项目 1-12：完全重写generate-portrait/route.ts文件
    *   修改内容: 
        - 添加API_ENDPOINTS多地址配置数组
        - 实现REQUEST_TIMEOUT和CONNECTION_TIMEOUT超时常量
        - 新增fetchWithTimeout函数支持AbortController
        - 新增tryApiEndpoints函数支持智能重试和多地址轮询
        - 移除GRSAI_API_URL环境变量依赖
        - 保留GRSAI_API_KEY验证逻辑
        - 重写ReadableStream流式响应处理
        - 添加safeEnqueue、safeClose、safeError安全控制函数
        - 实现连接监控定时器和心跳检测
        - 增强网络错误处理和重连机制
        - 完善资源清理和Reader释放
        - 保留原有PROMPT_TEMPLATE和characterDescription验证
    *   变更摘要: 成功将generate-portrait完全重构为与generate-animal-landmark一致的实现架构
    *   原因: 执行完整替换策略，确保API调用方式完全一致
    *   阻塞问题: 无
    *   状态: 等待用户确认

# Final Review (Populated by REVIEW mode)
[待REVIEW模式填充] 