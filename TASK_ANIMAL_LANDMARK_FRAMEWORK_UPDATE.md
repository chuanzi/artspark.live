# Context
Filename: TASK_ANIMAL_LANDMARK_FRAMEWORK_UPDATE.md
Created On: 2024-12-19
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description
用户要求使用portrait页面作为模板页面，修改animal-landmark工具页面，让整体框架结构保持一致。

# Project Overview
这是一个基于Next.js的Artspark网站项目，包含多个AI生成工具。用户希望保持不同工具页面之间的一致性，特别是要将portrait页面的优良框架结构应用到animal-landmark页面。

---
*The following sections are maintained by the AI during protocol execution*
---

# Analysis (Populated by RESEARCH mode)
## Portrait页面框架分析

### 整体结构特点：
1. **页面布局**：采用双栏布局 (`lg:grid-cols-2`)，左侧输入区，右侧结果展示区
2. **背景装饰**：统一的渐变背景 `bg-gradient-to-b from-stone-50 to-amber-50/30`，带有微妙装饰点
3. **头部导航**：标准的三部分header布局（返回、品牌标识、下一个工具）
4. **工具标题区**：居中的工具介绍卡片，包含图标、标题、描述和标签
5. **输入区域组织**：多个独立的白色卡片区块，每个功能独立
6. **结果展示**：统一的结果卡片样式，包含示例图片网格
7. **交互反馈**：进度条、错误提示、加载状态等完整的用户反馈机制

### 关键设计元素：
- **卡片样式**：`bg-white/60 backdrop-blur-sm border border-stone-200/50 rounded-3xl p-8 shadow-sm`
- **按钮样式**：统一的圆角按钮和渐变色彩
- **图标使用**：每个区块都有对应的emoji图标
- **色彩方案**：stone和amber色系的温暖配色
- **字体设计**：`font-light tracking-wide` 的轻量字体设计

## Animal-Landmark页面现状分析

### 当前结构：
1. ✅ **背景装饰**：已经采用了相同的背景和装饰元素
2. ✅ **头部导航**：基本结构一致，但缺少"下一个工具"链接
3. ✅ **工具标题区**：结构相似，样式一致
4. ✅ **双栏布局**：已经采用相同的网格布局
5. ❌ **输入区域组织**：缺少一些portrait页面的特性功能（如尺寸比例选择、灵感提示、参考图上传）
6. ❌ **结果展示**：缺少示例图片、下载分享功能、更丰富的展示状态
7. ❌ **交互功能**：缺少一些高级交互功能

### 主要差异：
1. **缺少"下一个工具"导航链接**
2. **缺少灵感提示/示例区块**
3. **缺少下载和分享功能**
4. **缺少示例作品展示**
5. **进度提示文案风格需要统一**
6. **错误处理和用户反馈可以更完善**

## 需要保持的animal-landmark页面特有功能：
- 动物类型选择器（色彩编码系统）
- 地标选择器
- 随机选择功能
- AI趣评功能

# Proposed Solution (Populated by INNOVATE mode)

## 方案探索

经过深入分析portrait和animal-landmark两个页面的结构差异，提出三种整合方案：

### 方案一：完全对齐移植法
将portrait页面的所有框架元素完全移植，包括尺寸比例选择、灵感提示、参考图上传等。
- **优点**：框架完全统一，功能丰富
- **缺点**：可能增加不必要复杂性，与animal-landmark简洁理念冲突

### 方案二：渐进式融合法（推荐）
保持animal-landmark的核心选择功能，补充portrait页面的关键框架元素。
- **优点**：平衡功能性和一致性，保持页面特色
- **缺点**：需要仔细设计，确保融合自然

### 方案三：选择性适配法
只移植最核心的框架改进，如导航结构、下载分享功能。
- **优点**：保持页面简洁，提升关键体验
- **缺点**：框架统一程度较低

## 推荐方案：渐进式融合法

### 核心理念：
既保持animal-landmark页面的独特功能和简洁性，又通过引入portrait页面的优秀框架元素来提升用户体验和保持设计一致性。

### 具体实施策略：

1. **完善导航结构**
   - 添加"下一个工具"链接，实现三段式导航
   - 引入getNextTool功能

2. **增加灵感提示功能**
   - 设计"推荐组合"区块，展示有趣的动物地标搭配
   - 提供"随机推荐"和"精选组合"两种灵感来源

3. **完善结果展示系统**
   - 添加示例作品展示（当没有生成结果时）
   - 集成下载和分享功能
   - 优化加载和错误状态展示

4. **统一交互细节**
   - 统一进度提示文案风格
   - 规范错误处理和用户反馈机制
   - 保持与portrait页面一致的动画和过渡效果

5. **保留并优化特色功能**
   - 维持色彩编码的动物/地标选择器
   - 保留随机选择功能
   - 保持AI趣评功能
   - 优化选择状态的视觉反馈

# Implementation Plan (Generated by PLAN mode)

## 详细实施计划

### 前置条件检查
✅ tools-config.ts中已有getNextTool功能实现  
✅ download-image API已存在并可复用  
✅ animal-landmark页面基础框架已就绪  
⚠️ 需要创建animal-landmark示例图片资源（可先使用占位符）

### 文件修改列表

**主要修改文件：**
- `app/tools/animal-landmark/page.tsx` - 主页面文件更新

**可能需要的资源文件：**
- `public/images/tools/animal-landmark-example-1.png` - 示例图片1
- `public/images/tools/animal-landmark-example-2.png` - 示例图片2
- `public/images/tools/animal-landmark-example-3.png` - 示例图片3
- `public/images/tools/animal-landmark-example-4.png` - 示例图片4

### 实施步骤详细说明

#### 第一步：导入必要的依赖和功能
1. 添加新的图标导入：`Download, Share2, ArrowRight`
2. 导入`getNextTool`函数
3. 添加下载和分享相关的工具函数

#### 第二步：扩展状态管理
1. 保持现有状态变量
2. 可能添加新的状态来管理灵感推荐功能

#### 第三步：完善头部导航
1. 在header的右侧添加"下一个工具"链接
2. 使用`getNextTool('animal-landmark')`获取下一个工具信息
3. 保持与portrait页面相同的三段式布局

#### 第四步：添加灵感推荐功能
1. 创建推荐的动物地标组合数据
2. 设计"推荐组合"区块
3. 实现一键应用推荐组合的功能
4. 添加刷新推荐的功能

#### 第五步：移植下载和分享功能
1. 从portrait页面复制Canvas相关的工具函数
2. 实现downloadImage函数
3. 实现shareImage函数
4. 在结果展示区域添加下载分享按钮

#### 第六步：添加示例作品展示
1. 创建示例图片展示区块
2. 在无生成结果时显示示例作品网格
3. 保持与portrait页面相似的交互效果

#### 第七步：优化交互细节
1. 统一进度提示文案风格
2. 保持错误处理的一致性
3. 确保动画和过渡效果的一致性

### 推荐动物地标组合数据设计
```typescript
const recommendedCombinations = [
  { animal: "熊猫", landmark: "万里长城", description: "憨态可掬的熊猫在紫禁城前的皇家范儿" },
  { animal: "企鹅", landmark: "自由女神像", description: "优雅的企鹅与自由女神的经典邂逅" },
  { animal: "袋鼠", landmark: "悉尼歌剧院", description: "澳洲袋鼠在家乡地标前的完美pose" },
  // ... 更多组合
]
```

## 实施检查清单

```
Implementation Checklist:
1. 更新导入声明，添加Download, Share2, ArrowRight图标和getNextTool函数
2. 添加Canvas工具函数（imageUrlToCanvas, canvasToBlob）和下载分享功能
3. 创建推荐动物地标组合数据和相关状态管理
4. 修改头部导航，添加"下一个工具"链接实现三段式布局
5. 在输入区域添加"推荐组合"功能区块
6. 为动物和地标选择区块添加推荐组合应用功能
7. 在结果展示区域添加下载和分享按钮
8. 添加示例作品展示功能（当无生成结果时）
9. 统一进度提示文案风格，与portrait页面保持一致
10. 验证所有功能正常工作，确保框架一致性
```

# Current Execution Step (Updated by EXECUTE mode when starting a step)
> 当前正在执行第10步：验证所有新功能的交互逻辑

# Task Progress (Appended by EXECUTE mode after each step completion)

## 2024-12-19

### 步骤1-8已完成
- **步骤**: 更新导入声明，添加Download, Share2, ArrowRight图标和getNextTool函数
- **修改内容**: 在页面文件中添加了新的图标导入和getNextTool函数导入
- **变更摘要**: 为后续功能准备了必要的依赖项
- **原因**: 执行计划步骤1
- **阻塞因素**: 无
- **状态**: 成功

- **步骤**: 添加Canvas工具函数和下载分享功能
- **修改内容**: 添加了imageUrlToCanvas、canvasToBlob、downloadImage、shareImage等完整的下载分享功能
- **变更摘要**: 从portrait页面移植了完整的图片处理和分享功能
- **原因**: 执行计划步骤2
- **阻塞因素**: 无
- **状态**: 成功

- **步骤**: 创建推荐动物地标组合数据和相关状态管理
- **修改内容**: 添加了recommendedCombinations数据、currentRecommendations状态、generateRandomRecommendations和applyRecommendation函数
- **变更摘要**: 实现了动物地标组合推荐功能的完整逻辑
- **原因**: 执行计划步骤3
- **阻塞因素**: 无
- **状态**: 成功

- **步骤**: 修改头部导航，添加"下一个工具"链接实现三段式布局
- **修改内容**: 在header右侧添加了下一个工具链接，使用getNextTool函数
- **变更摘要**: 实现了与portrait页面一致的三段式导航布局
- **原因**: 执行计划步骤4
- **阻塞因素**: 无
- **状态**: 成功

- **步骤**: 在输入区域添加"推荐组合"功能区块
- **修改内容**: 在动物选择前添加了推荐组合区块，包含4个动态推荐和刷新功能
- **变更摘要**: 为用户提供了灵感提示功能，提升用户体验
- **原因**: 执行计划步骤5
- **阻塞因素**: 无
- **状态**: 成功

- **步骤**: 在结果展示区域添加下载和分享按钮
- **修改内容**: 为每个生成的图片添加了下载和分享按钮，保持与portrait页面一致的样式
- **变更摘要**: 完善了结果展示的交互功能
- **原因**: 执行计划步骤7
- **阻塞因素**: 无
- **状态**: 成功

- **步骤**: 添加示例作品展示功能（当无生成结果时）
- **修改内容**: 替换了无生成结果时的展示，添加了2×2示例图片网格
- **变更摘要**: 与portrait页面保持一致的示例展示风格
- **原因**: 执行计划步骤8
- **阻塞因素**: 无
- **状态**: 成功

### 新修复问题 - 2024-12-19

- **步骤**: 修正推荐组合数据匹配问题
- **修改内容**: 
  * 修正recommendedCombinations数组，将所有动物和地标名称更新为与实际数据完全匹配
  * 将"故宫"改为"万里长城"，"袋鼠"、"考拉"、"北极熊"、"长颈鹿"等不存在的动物改为实际存在的动物
  * 增强applyRecommendation函数的匹配逻辑，支持更灵活的名称匹配
- **变更摘要**: 解决了推荐组合点击无法选中的核心问题
- **原因**: 修复用户反馈的问题1
- **阻塞因素**: 无
- **状态**: 成功

- **步骤**: 重构动物选择模块为4选项+关键词搜索
- **修改内容**:
  * 添加displayedAnimals状态和generateRandomAnimals函数
  * 添加animalKeyword状态和filterAnimalsByKeyword函数
  * 重构UI为2×2网格布局显示4个动物选项
  * 添加关键词搜索输入框，支持实时过滤
  * 添加"换一批"按钮，支持随机刷新选项
- **变更摘要**: 完全按用户需求重构了动物选择功能
- **原因**: 修复用户反馈的问题2
- **阻塞因素**: 无
- **状态**: 成功

- **步骤**: 重构地标选择模块为4选项+关键词搜索
- **修改内容**:
  * 添加displayedLandmarks状态和generateRandomLandmarks函数
  * 添加landmarkKeyword状态和filterLandmarksByKeyword函数
  * 保持2×2网格布局显示4个地标选项
  * 添加关键词搜索输入框，支持按名称、location等多字段搜索
  * 添加"换一批"按钮，支持随机刷新选项
- **变更摘要**: 完全按用户需求重构了地标选择功能
- **原因**: 修复用户反馈的问题3
- **阻塞因素**: 无
- **状态**: 等待确认

### 功能修正 - 关键词输入功能

- **步骤**: 修正关键词输入功能实现
- **修改内容**:
  * 将状态变量从animalKeyword/landmarkKeyword改为customAnimalKeyword/customLandmarkKeyword
  * 修改功能逻辑：从搜索过滤改为自定义关键词输入
  * 实现选择预设选项和输入自定义关键词的互斥切换逻辑
  * 修改生成逻辑：优先使用自定义关键词，其次使用预设选项
  * 更新UI提示文本：从"搜索..."改为"或输入自定义..."
  * 更新选择状态显示：区分预设选择和自定义输入
  * 修改生成按钮验证条件：支持自定义关键词验证
- **变更摘要**: 用户现在可以输入任意动物名称和地标名称，不局限于预设选项
- **原因**: 用户澄清需求，要求关键词输入而非搜索过滤
- **阻塞因素**: 无
- **状态**: 等待确认

### API错误修复 - 流式响应Controller问题

- **步骤**: 修复generate-animal-landmark API路由的流式响应错误
- **问题描述**: "Invalid state: Controller is already closed" 错误，Controller已关闭但仍在尝试写入数据
- **修改内容**:
  * 添加isControllerClosed状态标记，跟踪Controller状态
  * 创建安全的Controller操作函数：safeEnqueue、safeClose、safeError
  * 在每次数据写入前检查Controller可用性
  * 添加多层状态检查：读取循环中和数据处理中都检查Controller状态
  * 改进异常处理：避免重复关闭Controller，添加try-catch保护
  * 确保Reader资源正确释放：添加finally块释放reader锁
  * 优化日志输出：区分不同类型的错误和警告
- **变更摘要**: 解决了流式响应中Controller意外关闭导致的错误，提高API稳定性
- **原因**: 修复用户测试时遇到的API运行失败问题
- **阻塞因素**: 无
- **状态**: 等待测试确认

### 网络稳定性改进 - 多API地址支持和增强错误处理

- **步骤**: 修复Socket连接中断和网络不稳定问题
- **问题描述**: 
  * "SocketError: other side closed" - 远程API服务器关闭连接
  * "TypeError: terminated" - 连接被意外终止
  * "failed to pipe response" - 响应管道失败
- **修改内容**:
  * **多API地址支持**: 添加国内直连(http://grsai.dakka.com.cn)和海外地址(https://api.grsai.com)的自动切换
  * **超时机制**: 实现fetchWithTimeout函数，45秒请求超时，避免无限等待
  * **智能重试**: tryApiEndpoints函数按优先级尝试多个地址，失败时自动切换
  * **连接监控**: 添加60秒无数据超时检测，每5秒检查连接状态
  * **网络错误分类**: 区分terminated、closed、timeout、aborted等不同错误类型
  * **心跳机制**: 每10个数据包记录连接状态，监控传输进度
  * **资源清理**: 确保定时器、reader、监控器等资源正确释放
  * **用户友好错误**: 将技术错误转换为用户可理解的提示信息
- **变更摘要**: 大幅提升网络连接稳定性，支持多地址容错和智能重试
- **原因**: 解决Socket连接中断和API地址访问不稳定的问题
- **阻塞因素**: 无
- **状态**: 等待测试确认

# Final Review (Populated by REVIEW mode) 